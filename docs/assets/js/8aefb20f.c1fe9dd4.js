(window.webpackJsonp=window.webpackJsonp||[]).push([[31],{102:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return i})),n.d(t,"metadata",(function(){return s})),n.d(t,"toc",(function(){return l})),n.d(t,"default",(function(){return b}));var a=n(3),r=n(8),o=(n(0),n(138)),i={id:"workflow",title:"Workflow",sidebar_label:"Workflow",slug:"/workflow"},s={unversionedId:"workflow",id:"workflow",isDocsHomePage:!1,title:"Workflow",description:"Workflows are useful to handle sequential events. Let\u2019s say you want to execute one function after the other and you need results of the first function to execute the second function. The workflow will handle these kinds of events for you.",source:"@site/content/workflow.md",slug:"/workflow",permalink:"/docs/workflow",editUrl:"https://github.com/hypi-universe/docs/edit/master/content/workflow.md",version:"current",sidebar_label:"Workflow",sidebar:"docs",previous:{title:"User Defined Functions",permalink:"/docs/user-defined-function"},next:{title:"Triggers",permalink:"/docs/triggers"}},l=[{value:"Example",id:"example",children:[]}],p={toc:l};function b(e){var t=e.components,n=Object(r.a)(e,["components"]);return Object(o.b)("wrapper",Object(a.a)({},p,n,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,"Workflows are useful to handle sequential events. Let\u2019s say you want to execute one function after the other and you need results of the first function to execute the second function. The ",Object(o.b)("inlineCode",{parentName:"p"},"workflow")," will handle these kinds of events for you."),Object(o.b)("p",null,"Design the steps of the workflow and create an order of events. Execute the functions (work) inside the steps. Get the result after sequential processing of steps or functions. You may check the results of individual steps as well."),Object(o.b)("p",null,"Hypi provides below given ",Object(o.b)("inlineCode",{parentName:"p"},"Workflow")," data type for the implementation of the sequence of steps."),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-java"},"type Workflow {\n    name:\xa0String!\n    cronSchedule:\xa0String\n    execAs:\xa0String\n    async:\xa0Boolean\n    parallel:\xa0Boolean\n    maxExecutionTime:\xa0String\n    steps(...):\xa0[WorkflowStep!]\n}\n")),Object(o.b)("p",null,"The parameters are as follows:"),Object(o.b)("table",null,Object(o.b)("thead",{parentName:"table"},Object(o.b)("tr",{parentName:"thead"},Object(o.b)("th",{parentName:"tr",align:"center"},"Parameter"),Object(o.b)("th",{parentName:"tr",align:null},"Type"),Object(o.b)("th",{parentName:"tr",align:null},"Description"))),Object(o.b)("tbody",{parentName:"table"},Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",{parentName:"tr",align:"center"},Object(o.b)("strong",{parentName:"td"},"name")),Object(o.b)("td",{parentName:"tr",align:null},"String"),Object(o.b)("td",{parentName:"tr",align:null},"Name of the workflow")),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",{parentName:"tr",align:"center"},Object(o.b)("strong",{parentName:"td"},"cronSchedule")),Object(o.b)("td",{parentName:"tr",align:null},"String"),Object(o.b)("td",{parentName:"tr",align:null},"If present, this is a ","`","cron","`"," schedule to automatically execute this Workflow The syntax as defined at ",Object(o.b)("a",{parentName:"td",href:"https://www.manpagez.com/man/5/crontab/"},"https://www.manpagez.com/man/5/crontab/")," NOTE: The special strings @hourly, @daily, etc are NOT supported")),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",{parentName:"tr",align:"center"},Object(o.b)("strong",{parentName:"td"},"execAs")),Object(o.b)("td",{parentName:"tr",align:null},"String"),Object(o.b)("td",{parentName:"tr",align:null},"An ArcQL query to find the account e.g. hypi.id = 'user123' to find by id or username = 'blah' to find by username.",Object(o.b)("br",null),Object(o.b)("br",null),"If present, execution of the steps in the Workflow will be done as this account. If not specified, it defaults to the account making the request")),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",{parentName:"tr",align:"center"},Object(o.b)("strong",{parentName:"td"},"async")),Object(o.b)("td",{parentName:"tr",align:null},"Boolean"),Object(o.b)("td",{parentName:"tr",align:null},"Set to ","`","true","`"," for asynchronous processing")),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",{parentName:"tr",align:"center"},Object(o.b)("strong",{parentName:"td"},"parallel")),Object(o.b)("td",{parentName:"tr",align:null},"Boolean"),Object(o.b)("td",{parentName:"tr",align:null},"If present AND true, all steps in the workflow are executed at the same time.")),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",{parentName:"tr",align:"center"},Object(o.b)("strong",{parentName:"td"},"maxExecutionTime")),Object(o.b)("td",{parentName:"tr",align:null},"String"),Object(o.b)("td",{parentName:"tr",align:null},"Specifies the max time an async task should be allowed to execute. When this time has elapsed the task will be killed.",Object(o.b)("br",null),Object(o.b)("br",null),"The format is ISO8601 durations ",Object(o.b)("a",{parentName:"td",href:"https://en.wikipedia.org/wiki/ISO_8601"},"https://en.wikipedia.org/wiki/ISO_8601"),Object(o.b)("br",null),Object(o.b)("br",null),"#Durations e.g. P1M is 1 month and PT1M is 1 minute")),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",{parentName:"tr",align:"center"},Object(o.b)("strong",{parentName:"td"},"steps")),Object(o.b)("td",{parentName:"tr",align:null},"WorkflowStep"),Object(o.b)("td",{parentName:"tr",align:null},"Holds details of each workflow step")))),Object(o.b)("p",null,"Let\u2019s look into WorkflowStep as well:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-java"},"type WorkflowStep {\n    name:\xa0String\n    fn:\xa0GraphQLRef!\n    order:\xa0Int!\n}\n")),Object(o.b)("table",null,Object(o.b)("thead",{parentName:"table"},Object(o.b)("tr",{parentName:"thead"},Object(o.b)("th",{parentName:"tr",align:null},"Parameter"),Object(o.b)("th",{parentName:"tr",align:null},"Type"),Object(o.b)("th",{parentName:"tr",align:null},"Description"))),Object(o.b)("tbody",{parentName:"table"},Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",{parentName:"tr",align:null},Object(o.b)("strong",{parentName:"td"},"name")),Object(o.b)("td",{parentName:"tr",align:null},"String"),Object(o.b)("td",{parentName:"tr",align:null},"The name of the step")),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",{parentName:"tr",align:null},Object(o.b)("strong",{parentName:"td"},"fn")),Object(o.b)("td",{parentName:"tr",align:null},"GraphQLRef"),Object(o.b)("td",{parentName:"tr",align:null},"The function to execute for this step. The data returned by the step can subsequently be used in other steps. Set the type of the functions as query, mutation, or Subscription. Set the field to step name.")),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",{parentName:"tr",align:null},Object(o.b)("strong",{parentName:"td"},"order")),Object(o.b)("td",{parentName:"tr",align:null},"Int"),Object(o.b)("td",{parentName:"tr",align:null},"Order of the step")))),Object(o.b)("h3",{id:"example"},"Example"),Object(o.b)("p",null,"Let\u2019s take an example from a Library system. You go to the library to borrow a book. You get a list of authors. You choose an author and then you get a list of books by the author. You select the book from the list. The book becomes unavailable for others."),Object(o.b)("p",null,"Below are the steps for designing the schema:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},'Step-a:" Welcome to library"')),Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},"Step-b: Query: Get Author list")),Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},"Step-c: Query: Get a booklist by an author of your choice")),Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},"Step-d: Query: Get the ID of the selected book from the list")),Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},"Step-e: Mutation: Select the book with retrieved ID and update its availability "))),Object(o.b)("p",null,"Here is the schema for this Workflow."),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-java"},'type LibraryWork\xa0{\n    a:\xa0String\n    previous:\xa0Json\n    session:\xa0WorkflowSession,\n    params:\xa0Json\n}\n\ntype Query\xa0{\n    stepa:\xa0String@tan(type:Groovy,\xa0inline:\xa0"return\xa0\'Welcome\xa0to\xa0Library!\'")\n    stepb:\xa0Json@tan(type:Groovy,inline:"""\n      return\xa0gql(\\"""\n        query{\n                find\xa0(\n                type:\xa0Author,\xa0\n                arcql:\xa0"*")\n                {\n                    edges\xa0{\n                    cursor\n                    node\xa0{\n                        ...\xa0onAuthor\xa0{\n                        hypi\xa0{\n                           id\n                        }\n                        name\n                        }\n                    }\n                  }\n               }\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\n           }\xa0\xa0\n    \\"""\n        )\n    """)\xa0\xa0\n    stepc(a:String):\xa0Json@tan(type:Groovy,\xa0inline:\xa0"""\n      return\xa0\xa0gql(\\"""\n        query\xa0{\n            get(type:\xa0Author,\xa0id:\xa0"$a"){\n                ...\xa0onAuthor\xa0{\n                    hypi{\n                        id\n                     }\n                    name\n                booklist{\n                    title\n                    price\n                    authorid\n                }\n            }\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0}\n\xa0\xa0\xa0\xa0}\\"""\n\xa0\xa0\xa0\xa0)\n    """)\n    stepd(b:\xa0String):\xa0[String!]\xa0@tan(type:Groovy,\xa0inline:\xa0"""\n    def\xa0results\xa0=\xa0\xa0gql(\\"""\n    query\xa0{\n        find\xa0(\n            type:\xa0Book,\xa0\n            arcql:\xa0"title\xa0=\xa0\'$b\'"\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0)\xa0{\n                edges\xa0{\n                    cursor\n                    node\xa0{\n                    ...\xa0onBook\xa0{\n                        hypi\xa0{\n                        id\n                        }\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0}\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0}\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0}\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0}\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0}\n   \\"""\n\xa0\xa0\xa0)\xa0\n\xa0\xa0\xa0return\xa0results.data.find.edges.stream()\n\xa0\xa0 .map({o\xa0->\xa0o.node.hypi.id})\n\xa0\xa0\xa0.collect(java.util.stream.Collectors.toList())\xa0\xa0\n""")\xa0\xa0\n   stepf(a:\xa0String,\xa0previous:\xa0String,\xa0session:\xa0WorkflowSessionInput,\xa0\n   params:\xa0Json):\xa0\n   LibraryWork@tan(type:Groovy,\xa0inline:\xa0"""\n\xa0\xa0 return\xa0[\n\xa0\xa0\xa0\xa0"a":\xa0a,\n\xa0\xa0\xa0\xa0"previous":\xa0previous,\n\xa0\xa0\xa0\xa0"session":\xa0session,\n\xa0\xa0\xa0\xa0"params":\xa0params\n\xa0\xa0]\n""")\n   BorrowBook(a:\xa0String,b:\xa0String):\xa0LibraryWork@workflow(name:\xa0"BorrowBook")\n}\n\ntype Mutation\xa0{\n  # It is entirely\xa0up\xa0to\xa0the\xa0author\xa0to\xa0decide\xa0if\xa0their\xa0custom\xa0function\xa0\n  is\xa0mutation\xa0or\xa0not\n  stepe(previous:\\[String!\\]):\xa0Json@tan(type:Groovy,\xa0inline:\xa0"""\n      return\xa0gql(\\"""\n        mutation\xa0{\n        upsert(\n            values:\xa0{\xa0\n                Book:\xa0[\n                {\xa0\n                    hypi:{\n                        id:"${previous[0]}"\n                    }\n                    available:\xa0false\n                    }\n                 ]\xa0\n            })\xa0{\n                id\n            }\n        }\\"""\n    )\n""")\n}\n')),Object(o.b)("blockquote",null,Object(o.b)("p",{parentName:"blockquote"},"Important notes to understand the schema!")),Object(o.b)("p",null,"The first step can have any parameters you want. For the other steps, some rules are defined how the system maps parameters to the function in these steps."),Object(o.b)("p",null,"These rules are:"),Object(o.b)("ol",null,Object(o.b)("li",{parentName:"ol"},Object(o.b)("p",{parentName:"li"},"Any step (including the first step) can have a parameter ",Object(o.b)("inlineCode",{parentName:"p"},"params: Json")," i.e. name = params and type is ",Object(o.b)("inlineCode",{parentName:"p"},"Json"),"."),Object(o.b)("p",{parentName:"li"},"  The ",Object(o.b)("inlineCode",{parentName:"p"},"params")," is a map of the arguments passed to the first function in the Workflow. For example, if the function was defined as ",Object(o.b)("inlineCode",{parentName:"p"},"step1(a: Int, b: Json, c: MyType): T"),"."),Object(o.b)("p",{parentName:"li"},"  In this case, the ",Object(o.b)("inlineCode",{parentName:"p"},"params")," (Json) object would have the fields a, b, and c set to the values the function was executed with.")),Object(o.b)("li",{parentName:"ol"},Object(o.b)("p",{parentName:"li"},"Any step can have a parameter ",Object(o.b)("inlineCode",{parentName:"p"},"session: WorkflowSession"),". This is the current workflow session and contains the results of all steps before the current one. You can identify the results for a specific step by finding the result using the step's name in the session's data array.")),Object(o.b)("li",{parentName:"ol"},Object(o.b)("p",{parentName:"li"},"Except for the first step, a parameter ",Object(o.b)("inlineCode",{parentName:"p"},"previous: T")," can be used. ",Object(o.b)("inlineCode",{parentName:"p"},"T")," is the result type of the previous step from the workflow. "),Object(o.b)("p",{parentName:"li"},"  In this case, the platform will use the output of the previous function for this parameter. Note that if the type is not the same as the last step's output type then the workflow will fail if the field is not optional. If the field is optional then the platform will not provide it and it would therefore be null if you try to use it.")),Object(o.b)("li",{parentName:"ol"},Object(o.b)("p",{parentName:"li"},"Except for the first step, pass-through is possible. The parameters from the first step are passed through to other steps by name and type. Example"),Object(o.b)("p",{parentName:"li"},"  step1(a: Int, b: String): String\nstep2(a: Int): ID"),Object(o.b)("p",{parentName:"li"},'  In this case, the variable "a" in both step1 and step2 will have the same value that step1 was executed with. Incidentally, this is the same as getting "a" from the "params" (Json)'))),Object(o.b)("p",null,"The last step in the schema is given for the illustration purpose only to understand the usage of various parameters."),Object(o.b)("p",null,"To use the workflow, first create the workflow object in the system. The name of the workflow is important. Notice it is used in the function definition",Object(o.b)("inlineCode",{parentName:"p"},'@workflow(name: "BorrowBook")'),". This is the same name used in the object created. "),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-java"},'{\n "values": {\n     "Workflow": [\n         {\n         "name": "BorrowBook",\n         "steps": [\n             {\n                 "name": "stepa",\n                 "order": 0,\n                 "fn": {\n                 "type": "Query",\n                     "field": "stepa"\n                 }\n             },\n             {\n                 "name": "stepb",\n                 "order": 1,\n                 "fn": {\n                     "type": "Query",\n                     "field": "stepb"\n                 }\n             },\n             {\n                 "name": "stepc",\n                 "order": 2,\n                 "fn": {\n                     "type": "Query",\n                     "field": "stepc"\n                 }\n             },\n             {\n                 "name": "stepd",\n                 "order": 3,\n                 "fn": {\n                     "type": "Query",\n                     "field": "stepd"\n                 }\n             },\n             {\n                 "name": "stepe",\n                 "order": 4,\n                 "fn": {\n                     "type": "Mutation",\n                     "field": "stepe"\n                 }\n             },\n             {\n                 "name": "stepf",\n                 "order": 5,\n                 "fn": {\n                     "type": "Query",\n                     "field": "stepf",\n                     "selection": "a previous params session\n                     {data{stepName,stepResult}}"\n                 }\n                 }\n             ]\n             }\n         ]\n     }\n}\n')),Object(o.b)("p",null,"To use this workflow execute it like any other function."),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-java"},'query Q($a: String, $b: String){BorrowBook1(a: $a, b:$b){\n a previous params\n     session{\n         data{\n             stepName\n             stepResult\n         }\n     }\n  }\n}\n\n#Data\n{\n "a": "Author1",\n "b": "Inferno"\n}\n')),Object(o.b)("p",null,"Verify the step results:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-json"},'{\n  "data": {\n    "BorrowBook1": {\n      "a": "Author1",\n      "previous": null,\n      "params": {\n        "a": "Author1",\n        "b": "Inferno"\n      },\n      "session": {\n        "data": [\n          {\n            "stepName": "stepa",\n            "stepResult": "Welcome to Library!"\n          },\n          {\n            "stepName": "stepb",\n            "stepResult": {\n              "data": {\n                "find": {\n                  "edges": [\n                    {\n                      "cursor": "Author1",\n                      "node": {\n                        "hypi": {\n                          "id": "Author1"\n                        },\n                        "name": "Dan Brown"\n                      }\n                    },\n                    {\n                      "cursor": "Author2",\n                      "node": {\n                        "hypi": {\n                          "id": "Author2"\n                        },\n                        "name": "Paulo Coelho"\n                      }\n                    },\n                    {\n                      "cursor": "Author3",\n                      "node": {\n                        "hypi": {\n                          "id": "Author3"\n                        },\n                        "name": "Sudha Murti"\n                      }\n                    }\n                  ]\n                }\n              }\n            }\n          },\n          {\n            "stepName": "stepc",\n            "stepResult": {\n              "data": {\n                "get": {\n                  "hypi": {\n                    "id": "Author1"\n                  },\n                  "name": "Dan Brown",\n                  "booklist": [\n                    {\n                      "title": "Da Vinci Code",\n                      "price": 12.99,\n                      "authorid": 1\n                    },\n                    {\n                      "title": "The Last Symbol",\n                      "price": 10,\n                      "authorid": 1\n                    },\n                    {\n                      "title": "Inferno",\n                      "price": 5.99,\n                      "authorid": 1\n                    }\n                  ]\n                }\n              }\n            }\n          },\n          {\n            "stepName": "stepd",\n            "stepResult": [\n              "Author1Book3"\n            ]\n          },\n          {\n            "stepName": "stepe",\n            "stepResult": {\n              "data": {\n                "upsert": [\n                  {\n                    "id": "Author1Book3"\n                  }\n                ]\n              }\n            }\n          }\n        ]\n      }\n    }\n  }\n}\n')))}b.isMDXComponent=!0},138:function(e,t,n){"use strict";n.d(t,"a",(function(){return c})),n.d(t,"b",(function(){return m}));var a=n(0),r=n.n(a);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var p=r.a.createContext({}),b=function(e){var t=r.a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},c=function(e){var t=b(e.components);return r.a.createElement(p.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},d=r.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,i=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),c=b(n),d=a,m=c["".concat(i,".").concat(d)]||c[d]||u[d]||o;return n?r.a.createElement(m,s(s({ref:t},p),{},{components:n})):r.a.createElement(m,s({ref:t},p))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:a,i[1]=s;for(var p=2;p<o;p++)i[p]=n[p];return r.a.createElement.apply(null,i)}return r.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"}}]);